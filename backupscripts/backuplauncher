#!/bin/bash

source "/opt/galaxymediatools/functions/prechecknl"

LOGF="/video/Incoming/logs/backupmaster.log"

backupcomplete() {
ELAPSED2=$(elapsed2)
if [ $? -eq 0 ]; then
log "INFO" "$1 Library backup completed successfully. Elapsed: $ELAPSED2"
echo "0"
else
log "ERROR" "$1 Library backup failed. Elapsed: $ELAPSED2"
echo "1"
fi
}

starttimer
log "INFO" "Screened BackupLauncher script starting..."

if mountpoint -q $MOUNT1
then
log "WARN" "Backup1 was mounted already, unmouting for health checks"
umount $MOUNT1
fi

if mountpoint -q $MOUNT2
then
log "WARN" "Backup2 was mounted already, unmouting for health checks"
umount $MOUNT2
fi

#starttimer3
#log "INFO" "Resetting USB device $MOUNT1"
#/opt/galaxymediatools/usbreset /dev/bus/usb/004/003
#ELAPSED3=$(elapsed3)
#log "INFO" "Resetting USB device $MOUNT1 complete Elapsed: $ELAPSED3"

starttimer3
log "INFO" "SMART drive check starting on $MOUNT1"
smartctl -T permissive -a -d sat,auto /dev/disk/by-uuid/$DUUID1
ELAPSED3=$(elapsed3)
log "INFO" "SMART drive check complete on $MOUNT1 Elapsed: $ELAPSED3"

starttimer3
log "INFO" "Running NTFS Fix on $MOUNT1"
ntfsfix /dev/disk/by-uuid/$DUUID1 &>> $LOGF 
ELAPSED3=$(elapsed3)
log "INFO" "NTFS Fix complete on $MOUNT1 Elapsed: $ELAPSED3"

if /bin/mount UUID=$DUUID1 "$MOUNT1"; then
starttimer3
starttimer2
log "INFO" "Stand-Up Comedy Library backup starting..."
/opt/galaxymediatools/backupscripts/backupcomedy.exec 
CRESULT=backupcomplete "Stand-Up Comedy"

starttimer2
log "INFO" "Movie Library backup starting..."
/opt/galaxymediatools/backupscripts/backupmovies.exec
MRESULT=backupcomplete "Movie"

starttimer2
log "INFO" "UFC Event Library backup starting..."
/opt/galaxymediatools/backupscripts/backupufc.exec
URESULT=backupcomplete "UFC Events"
ELAPSED3=$(elapsed3)
log "INFO" "Backups on $MOUNT1 complete.  Elapsed: $ELAPSED3"

log "INFO" "Un-Mounting $MOUNT1"
/bin/sync
D1=`df -h | grep "$MOUNT1"`
IFS=' ' read -r -a D1INFO <<< $D1
D1PERC=${D1INFO[4]}
D1FREE=${D1INFO[3]}
/bin/umount $MOUNT1
else
 log "ERROR" "Backup Error, Backup1 not mounting!"
 pushover "backup" "Backup Error, Backup1 not mounting!"
fi

#starttimer3
#log "INFO" "Putting USB device $MOUNT1 to sleep"
#udisksctl power-off -b /dev/disk/by-uuid/$DUUID1
#ELAPSED3=$(elapsed3)
#log "INFO" "USB device $MOUNT1 sleep complete Elapsed: $ELAPSED3"


#starttimer3
#log "INFO" "Resetting USB device $MOUNT2"
#/opt/galaxymediatools/usbreset /dev/bus/usb/004/002
#ELAPSED3=$(elapsed3)
#log "INFO" "Resetting USB device $MOUNT2 complete Elapsed: $ELAPSED3"

if /bin/mount UUID=$DUUID2 "$MOUNT2"; then
starttimer3
log "INFO" "Running NTFS Fix on $MOUNT2"
ntfsfix /dev/disk/by-uuid/$DUUID2 &>> $LOGF
ELAPSED3=$(elapsed3)
log "INFO" "NTFS Fix complete on $MOUNT2 Elapsed: $ELAPSED3"

starttimer3
starttimer2
log "INFO" "TV Show Library backup starting..."
/opt/galaxymediatools/backupscripts/backuptvshows.exec
TRESULT=backupcomplete "TV Show"

starttimer2
log "INFO" "Recorded TV Library backup starting..."
/opt/galaxymediatools/backupscripts/backuprecordedtv.exec
RRESULT=backupcomplete "Recorded TV"

ELAPSED3=$(elapsed3)
log "INFO" "Backups on $MOUNT2 complete.  Elapsed: $ELAPSED3"

log "INFO" "Un-Mounting $MOUNT2"
/bin/sync
D2=`df -h | grep "$MOUNT2"`
IFS=' ' read -r -a D2INFO <<< $D2
D2PERC=${D2INFO[4]}
D2FREE=${D2INFO[3]}
/bin/umount $MOUNT2
else
 log "ERROR" "Backup Error, Backup2 not mounting!"
 pushover "backup" "Backup Error, Backup2 not mounting!"
fi


#starttimer3
#log "INFO" "Putting USB device $MOUNT2 to sleep"
#udisksctl power-off -b /dev/disk/by-uuid/$DUUID2
#ELAPSED3=$(elapsed3)
#log "INFO" "USB device $MOUNT2 sleep complete Elapsed: $ELAPSED3"

if [ -f /var/run/reboot-required ]; then
  if [ "$1" != "-ns" ]; then
  log "WARN" "Reboot required. Rebooting..."
  else
  log "WARN" "Reboot required. But skipping due to NO SLEEP option"
  fi
  SUS=2
else
  if [ "$1" != "-ns" ]; then
  log "WARN" "No Reboot needed. Suspending machine."
  else
  log "INFO" "No Reboot needed. But not Suspending machine due to NO SLEEP option"
  fi
SUS=1
fi

log "INFO" "USB drive $MOUNT1 - $D1FREE Free, $D1PERC Used."
log "INFO" "USB drive $MOUNT2 - $D2FREE Free, $D2PERC Used."

ELAPSED=$(elapsed)
log "DEBUG" "CRESULT=$CRESULT, MRESULT=$MRESULT, URESULT=$URESULT, TRESULT=$TRESULT, RRESULT=$RRESULT"

if [ $CRESULT -eq 0 ] && [ $MRESULT -eq 0 ] && [ $URESULT -eq 0 ] && [ $TRESULT -eq 0 ] && [ $RRESULT -eq 0 ]; then
log "INFO" "All Library backups completed successfully!"
pushover "backup" "Library backups completed successfully. Backup1 $D1PERC Used $D1FREE Free, Backup2 $D2PERC Used $D2FREE Free. Elapsed: $ELAPSED"
else
ERRORED=$(($CRESULT+$MRESULT+$URESULT+$TRESULT+$URESULT))
log "DEBUG" "ERRORED=$ERRORED"
log "INFO" "Library backups completed with errors. $ERRORED Libraries failed. Elapsed: $ELAPSED"
pushover "backup" "Library backups completed with errors. $ERRORED Libraries failed. Backup1 $D1PERC Used $D1FREE Free, Backup2 $D2PERC Used $D2FREE Free. Elapsed: $ELAPSED"
fi

log "INFO" "<--- Master Backup script completed. Elapsed: $ELAPSED"
sleep 10
if [ "$1" != "-ns" ]; then
if [ $SUS -eq 1 ]; then
/usr/sbin/pm-suspend
else
/sbin/reboot
fi
fi
